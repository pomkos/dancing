---
title: "Dance Entropy Analysis"
author: "Peter Gates"
date: "10/30/2019"
output:
  pdf_document: 
    toc: yes
    toc_depth: 6
  word_document: default
  html_document: default
---
```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate) # date time formatting
library(ggplot2)
library(ggthemes)
df <- read_csv("C:/Users/albei/Nextcloud/Documents/PhD/Ridgel Lab/Dance Poster/Entropy Analysis/Data/SamEn_joints.csv")
```

Entropy has been calculated using MatLab code for 176 biomechanical variables measured through the Noraxon system during dance sessions in participants with Parkinson's Disease (PD) and control older adults (OA). This document outlines the statistical results. 

### Data Cleaning

Data was cleaned using the following criteria:

* Date was extracted from filename and added to new Date column
* Participant ID extracted from filename and added to new Participant column
* Dance Type was extracted from filename and added to new Dance Type column
* Rumba, Swing, Electric Slide data were removed
* New Group column was created where data was organized into "OA" or "PD"
* All values equal to "0" were replaced with "NA". 0 indicates a failure of the biomechanical sensors and thus are excluded from analysis
* One observation of Tango was removed as there were NA data for any of the variables.

The cleaned data were saved as df_clean.

df_clean was further separated into PD or OA data, for ease of analysis. These are shown below.

```{r clean, include=FALSE, echo=TRUE}
df_clean_path = "C:/Users/albei/Nextcloud/Documents/PhD/Ridgel Lab/Dance Poster/Entropy Analysis/Data/clean_samen.csv"

df_clean <- df %>%
  # Extract appropriate entropy
  select(-useless_col) %>%
  # Create Date column
  mutate(Date = str_extract(string = file_name, pattern = "^20..............")) %>%
  mutate(Date = ymd_hm(Date)) %>%
  # Create Participant column
  mutate(Participant = str_extract(file_name, "pddance[0-9][0-9][0-9]|pddancecon[0-9][0-9][0-9]")) %>%
  mutate(Participant = factor(Participant)) %>%
  # Create Dance_Type column
  mutate(file_name = str_remove(file_name,".*pddance[0-9][0-9][0-9]_")) %>%
  mutate(file_name = str_remove(file_name,".*pddancecon[0-9][0-9][0-9]_")) %>%
  mutate(Dance_Type = str_remove(file_name,".xlsx")) %>%  
  # Reorder, remove duplicates
  select(Date, Participant, Dance_Type, ends_with("(deg)")) %>% # EDIT ME
  # Clean Dance column
  mutate(Dance_Type = str_replace(Dance_Type, pattern = ".*Tango.*|.*tango.*", replacement = "Tango")) %>%
  mutate(Dance_Type = str_replace(Dance_Type, pattern = ".*Waltz.*|.*waltz.*", replacement = "Waltz")) %>%
  mutate(Dance_Type = str_replace(Dance_Type, pattern = ".*Waltz.*|.*waltz.*", replacement = "Waltz")) %>%
  mutate(Dance_Type = str_replace(Dance_Type, pattern = ".*line.*|.*Line.*", replacement = "Line Dance")) %>%
  mutate(Dance_Type = str_replace(Dance_Type, pattern = ".*foxtrot.*|.*Foxtrot.*", replacement = "Foxtrot")) %>%
  mutate(Dance_Type = str_replace(Dance_Type, pattern = ".*Prominent.*", replacement = "Tango")) %>%
  mutate(Dance_Type = str_replace(Dance_Type, pattern = ".*BoxStep.*", replacement = "Foxtrot")) %>%
  mutate(Dance_Type = str_replace(Dance_Type, pattern = ".*Electric slide.*|.*Electric Slide.*", replacement = "Electric_Slide")) %>%
  mutate(Dance_Type = str_replace(Dance_Type, pattern = ".*rumba.*|.*Rumba.*", replacement = "Rumba")) %>%
  mutate(Dance_Type = factor(Dance_Type)) %>%
  # Remove Rumba, Swing, Electric Slide
  filter(Dance_Type != "Rumba") %>%
  filter(Dance_Type != "Swing") %>%
  filter(Dance_Type != "Electric_Slide") %>%
  # Control v PD column
  mutate(Group = Participant) %>%
  mutate(Group = str_replace(Group, pattern = ".*pddancecon.*", replacement = "OA")) %>%
  mutate(Group = str_replace(Group, pattern = ".*pddance.*", replacement = "PD")) %>%
  mutate(Group = factor(Group))

df_clean[df_clean == 0] <- NA

write_csv(df_clean, path = df_clean_path)
```

```{r separate, include=FALSE, echo=TRUE}
df_pd_path = "C:/Users/albei/Nextcloud/Documents/PhD/Ridgel Lab/Dance Poster/Entropy Analysis/Data/pd_samen.csv"
df_oa_path = "C:/Users/albei/Nextcloud/Documents/PhD/Ridgel Lab/Dance Poster/Entropy Analysis/Data/oa_samen.csv"

df_pd <- df_clean %>%
  filter(Group == "PD")

df_oa <- df_clean %>%
  filter(Group == "OA")

```

``` {r heads}
df_pd
df_oa
```

### Data Statistics

#### Descriptive Statistics

```{r describe_stats, echo=F}
library(tidyselect) # needed for peek_vars
library(formattable) # needed to make pretty tables
library(kableExtra) # makes pretty tables for PDF
library(xtable) # makes auto-tables for functions like anova, outputs in latex or html
df_test <- df_clean 
df_clean
df_test <- df_test[-c(8),] # removes a row. It had outlier for Tango Hip Abduction. This df not used for anything, saved for posterity.
df_clean_stats <- df_clean[-1:-2]

df_clean_desc <-df_clean_stats %>%
  rename_at(vars(starts_with("SamEn_")), ~str_replace(., "SamEn_", "")) %>% # delete "SamEn_" from column names
  rename_at(vars(ends_with("(deg)")), ~str_replace(., "\\(deg\\)", "")) %>% # delete "(deg)" from column names
  group_by(Group, Dance_Type) %>%
  summarise_all(list(mean), na.rm = TRUE) %>%
  mutate_if(is.numeric, round, 3) %>% # Round all numbers
  # Organize columns
  select(sort(peek_vars())) %>% # sorts columns alphabetically. Peek_Vars returns currently registered variables.
  select(-c("Elbow-RT-Flexion ", "Hip-RT-Abduction ", "Hip-RT-Flexion ", "Hip-RT-Rotation Ext ", "Knee-RT-Flexion ", "Group"), 
         c("Elbow-RT-Flexion ", "Hip-RT-Abduction ", "Hip-RT-Flexion ", "Hip-RT-Rotation Ext ", "Knee-RT-Flexion ")) %>% # All rights to end
  rename_at(vars(ends_with("_fn1")), ~str_replace(., "_fn1", "_mean")) %>%
  # rename_at(vars(ends_with("_fn3")), ~str_replace(., "_fn3", "_vars")) %>%
  # Kable function makes pretty table in PDF
  kable(booktabs = T, linesep = "", longtable = F, caption = "Mean SamEn of Variables per Dance") %>%
  kable_styling(latex_options = c("striped", "scale_down"), # highlight rows, make table fit page with "scale_down".
                stripe_index = c(3,7)) %>% # which rows to highlight 
  add_header_above(c(" " = 2, "Left Side" = 5, "Right Side" = 5)) %>%
  pack_rows("Older Adults Group", 1, 4) %>%
  pack_rows("Parkinson's Disease Group", 5,8) %>%
  column_spec(1:12, width = "5em") %>%
  footnote(general = "OA group was all female, PD group was all male.")

fm2 <- lm(`SamEn_Elbow-LT-Flexion (deg)` ~ Dance_Type, data = df_clean)

df_clean_desc
```
#### Difference between sides, within dances

The plots below demonstrate that for PD participants Foxtrot had the greatest mean SamEn of both left elbow flexion and left knee flexion, reenforcing our findings from the TukeyHSD run above.

PD participants also tended to show greater mean right hip abduction SamEn when compared to OA participants.

##### PD left v right side

Is there a significant difference in left vs right SamEn, per Dance_Type?

H0: left_variable = right_variable

HA: left_variable > right_variable

| p values| Elbow Flexion| Hip Abduction| Hip Rotation| Hip Flexion| Elbow Flexion|
| --------| ------------ | ------------ | ----------- | ---------- | ------------ |
| Tango   | 0.02333 | 0.00000046 | 0.000096 | 0.71698 | 0.47055 |
| Foxtrot | 0.52267 | 0.02530 | 0.08354 | 0.56562 | 0.00612 |

PD Line and Waltz did not have enough data for a t test.

```{r pd_left_v_right, echo=FALSE, include=FALSE}
library(reshape2) # for melt function

df_clean2 <- df_clean[-1:-2]

df_clean2_pd <- df_clean2 %>%
  filter(Group == "PD")

## Tango
df_clean2_pd_tango <- df_clean2_pd %>%
  filter(Dance_Type == "Tango")

meltdf_pd_tango <- melt(df_clean2_pd_tango)
pairwise.t.test(meltdf_pd_tango$value, meltdf_pd_tango$variable, p.adjust = "none")
                  # p_value
  # Elbow_Flexion: 0.02333
  # Hip_Abduction: 4.6e-07 (2.0e-13 without outlier)
  # Hip_Rotation:  9.6e-05
  # Hip_Flexion:   0.71698
  # Knee_Flexion:  0.47055

## Foxtrot
df_clean2_pd_foxtrot <- df_clean2_pd %>%
  filter(Dance_Type == "Foxtrot")

meltdf_pd_foxtrot <- melt(df_clean2_pd_foxtrot)
pairwise.t.test(meltdf_pd_foxtrot$value, meltdf_pd_foxtrot$variable, p.adjust = "none")
                  # p_value
  # Elbow_Flexion: 0.52267
  # Hip_Abduction: 0.02530
  # Hip_Rotation:  0.08354
  # Hip_Flexion:   0.56562
  # Knee_Flexion:  0.00612

## Line Dance
df_clean2_pd_line <- df_clean2_pd %>%
  filter(Dance_Type == "Line Dance")

meltdf_pd_line <- melt(df_clean2_pd_line)
pairwise.t.test(meltdf_pd_line$value, meltdf_pd_line$variable, p.adjust = "none")
                  # p_value
  # Elbow_Flexion: 
  # Hip_Abduction: 
  # Hip_Rotation:  
  # Hip_Flexion:   
  # Knee_Flexion:  

## Waltz
df_clean2_pd_waltz <- df_clean2_pd %>%
  filter(Dance_Type == "Waltz")

meltdf_pd_waltz <- melt(df_clean2_pd_waltz)
pairwise.t.test(meltdf_pd_waltz$value, meltdf_pd_waltz$variable, p.adjust = "none")
                  # p_value
  # Elbow_Flexion: 
  # Hip_Abduction: 
  # Hip_Rotation:  
  # Hip_Flexion:   
  # Knee_Flexion:  

```

###### PD Plot

```{r pd_face_bars, echo=FALSE}
library(reshape2) # for melt(...) function
library(ggsignif) # for adding sig label to ggplot2

df_clean2 <- df_clean[-1:-2]
gg <- melt(df_clean2,id=c("Group","Dance_Type"))   #turns all variables into observations
pos <- position_jitter(width = 0.25, seed = 21) # standardizes jitter
## PD
gg2_PD <- gg %>%
  # Create Left/Side column
  mutate(Side = str_extract(string = variable, pattern = "-..-")) %>%
  mutate(variable = str_replace(variable, pattern = "-LT-", replacement = "")) %>%
  mutate(variable = str_replace(variable, pattern = "-RT-", replacement = "")) %>%
  mutate(variable = str_replace(variable, pattern = "\\(deg\\)", replacement = "")) %>%
  mutate(variable = str_replace(variable, pattern = "SamEn_", replacement = "")) %>%
  mutate(Side = str_replace(Side, pattern = "-LT-", replacement = "Left")) %>%
  mutate(Side = str_replace(Side, pattern = "-RT-", replacement = "Right")) %>%
  filter(Group == "PD")

pd_signif_annotate <- data.frame(Dance_Type = c("Tango", 
                                                "Foxtrot"),
                                 start = c(0.7, 1.7, 2.7, 3.7, 4.7,
                                           0.7, 1.7, 2.7, 3.7, 4.7),
                                 end = c(1.25, 2.25, 3.25, 4.25, 5.25,
                                         1.25, 2.25, 3.25, 4.25, 5.25),
                                 y = c(0.15, 0.175, 0.15, 0.175, 0.15,
                                       0.15, 0.175, 0.15, 0.175, 0.15),
                                 label = c("0.023", "0.025", "  NS ", "0.084",  " NS  ", 
                                            "0.006",  "<0.0001", " NS  ", "< 0.0001", "0.006 ")
                                 )
my_graph<- ggplot(gg2_PD, aes(x=variable, y=value)) + 
  geom_point(position=pos, aes(color = Side)) + 
  geom_vline(xintercept = 1.5) +
  geom_vline(xintercept = 2.5) +
  geom_vline(xintercept = 3.5) +
  geom_vline(xintercept = 4.5) +
  facet_wrap(~Dance_Type)+
  ggtitle("PD SamEn in Left and Right Sides") + 
  xlab("Noraxon Measurements") +
  ylab("Sample Entropy") +
  scale_fill_discrete(name = "") +
  ylim(0,0.2) +
  theme(axis.text.x = element_text(angle = 90)) +
  geom_signif(data = pd_signif_annotate,
              aes(xmin = start,
                  xmax = end,
                  annotations = label,
                  y_position = y),
              textsize = 2.5,
              vjust = -0.04,
              manual = TRUE)


my_graph
```

##### OA left v right side

Is there a significant difference in left vs right SamEn, per Dance_Type?

H0: left_variable != right_variable

HA: left_variable = right_variable

| p values| Elbow Flexion| Hip Abduction| Hip Rotation| Hip Flexion| Elbow Flexion|
| --------| ------------ | ------------ | ----------- | ---------- | ------------ |
| Tango   | 0.29891 | 0.00207 | 0.20024 | 0.01039 | 0.89776 |

OA Foxtrot, Line and Waltz did not have enough data for a t test.

```{r oa_left_v_right, echo=FALSE, include=FALSE}
library(reshape2) # for melt function
df_clean2 <- df_clean[-1:-2]

df_clean2_oa <- df_clean2 %>%
  filter(Group == "OA")
df_clean2_oa
## Tango
df_clean2_oa_tango <- df_clean2_oa %>%
  filter(Dance_Type == "Tango")

meltdf_oa_tango <- melt(df_clean2_oa_tango)
pairwise.t.test(meltdf_oa_tango$value, meltdf_oa_tango$variable, p.adjust = "none")
                  # p_value
  # Elbow_Flexion: 0.29891
  # Hip_Abduction: 0.00207
  # Hip_Rotation:  0.01039
  # Hip_Flexion:   0.20024
  # Knee_Flexion:  0.89776

```

###### OA Plot

```{r oa_face_bars, echo=FALSE}
## OA
gg2_OA <- gg %>%
  # Create Left/Side column
  mutate(Side = str_extract(string = variable, pattern = "-..-")) %>%
  mutate(variable = str_replace(variable, pattern = "-LT-", replacement = "")) %>%
  mutate(variable = str_replace(variable, pattern = "-RT-", replacement = "")) %>%
  mutate(variable = str_replace(variable, pattern = "\\(deg\\)", replacement = "")) %>%
  mutate(variable = str_replace(variable, pattern = "SamEn_", replacement = "")) %>%
  mutate(Side = str_replace(Side, pattern = "-LT-", replacement = "Left")) %>%
  mutate(Side = str_replace(Side, pattern = "-RT-", replacement = "Right")) %>%
  filter(Group == "OA")

oa_signif_annotate <- data.frame(Dance_Type = "Tango",
                                 start = c(0.7, 1.7, 2.7, 3.7, 4.7),
                                 end = c(1.25, 2.25, 3.25, 4.25, 5.25),
                                 y = c(0.075, 0.11, 0.11, 0.15, 0.11),
                                 label = c(" NS", "0.00207", " NS ", "0.01039", "  NS  ")
                                 )
ggplot(gg2_OA, aes(x=variable, y=value)) + 
  geom_point(position=pos, aes(color = Side)) + 
  geom_vline(xintercept = 1.5) +
  geom_vline(xintercept = 2.5) +
  geom_vline(xintercept = 3.5) +
  geom_vline(xintercept = 4.5) +
  facet_wrap(~Dance_Type)+
  ggtitle("OA SamEn in Left and Right Sides") + 
  xlab("Noraxon Measurements") +
  ylab("Sample Entropy") +
  scale_fill_discrete(name = "") +
  ylim(0,0.2) +
  theme(axis.text.x = element_text(angle = 90)) +
  geom_signif(data = oa_signif_annotate,
              aes(xmin = start,
                  xmax = end,
                  annotations = label,
                  y_position = y),
              textsize = 2.5,
              vjust = -0.04,
              manual = TRUE)

```


<!-- Plotted below are the SamEn of those variables that proved to be significantly different between dances in PD participants. Next to each plot is the OA equivalent. From here we can see that: -->

<!-- * PD participants had a much wider range in SamEn of left hip abduction than OA participants during Tango -->
<!-- * Both PD and OA participants had lower SamEn of left elbow flexion than right elbow flexion -->
<!-- * PD participants had a wider range in SamEn of left knee flexion than OA participants during Tango -->

```{r graphs_dot, echo=FALSE, include=FALSE}
library(ggrepel)
pos <- position_jitter(width = 0.5, seed = 2) # standardizes randomness

elbow_plt <- ggplot(df_clean, aes(x = Dance_Type)) + 
  geom_point(position = pos,
             aes(y = df_clean$`SamEn_Elbow-RT-Flexion (deg)`,
                 color = "6532")
  ) +
  geom_point(position = pos,
             aes(y = df_clean$`SamEn_Elbow-LT-Flexion (deg)`,
                 color = "8965"),
  ) +
  labs(title = "SamEn of Elbow Flexion",
       x = "Dance Types", 
       y = "SamEn") +
  theme(plot.title = element_text(hjust = 0.55),
        legend.position = "right") +
  geom_vline(xintercept = 1.5) +
  geom_vline(xintercept = 2.5) +
  geom_vline(xintercept = 3.5) +
  ylim(0,0.2) +
  scale_color_manual(name = "Location",
                     labels = c("Right Elbow Flexion", "Left Elbow Flexion"),
                     values = c("red","black")) +
  facet_wrap(~ Group)

hip_plt <- ggplot(df_clean, aes(x = Dance_Type)) + 
  geom_point(position = pos,
             aes(y = df_clean$`SamEn_Hip-RT-Abduction (deg)`,
                 color = "6532")
  ) +
  geom_point(position = pos,
             aes(y = df_clean$`SamEn_Hip-LT-Abduction (deg)`,
                 color = "8965"),
  ) +
  labs(title = "SamEn of Hip Abduction",
       x = "Dance Types", 
       y = "SamEn") +
  theme(plot.title = element_text(hjust = 0.55),
        legend.position = "right") +
  geom_vline(xintercept = 1.5) +
  geom_vline(xintercept = 2.5) +
  geom_vline(xintercept = 3.5) +
  ylim(0,0.2) +
  scale_color_manual(name = "Location",
                     labels = c("Right Hip Abduction", "Left Hip Abduction"),
                     values = c("red","black")) +
  facet_wrap(~ Group)

knee_plt <- ggplot(df_clean, aes(x = Dance_Type)) + 
  geom_point(position = pos,
             aes(y = df_clean$`SamEn_Knee-RT-Flexion (deg)`,
                 color = "6532")
  ) +
  geom_point(position = pos,
             aes(y = df_clean$`SamEn_Knee-LT-Flexion (deg)`,
                 color = "8965"),
  ) +
  labs(title = "SamEn of Knee Flexion",
       x = "Dance Types", 
       y = "SamEn") +
  theme(plot.title = element_text(hjust = 0.55),
        legend.position = "right") +
  geom_vline(xintercept = 1.5) +
  geom_vline(xintercept = 2.5) +
  geom_vline(xintercept = 3.5) +
  ylim(0,0.2) +
  scale_color_manual(name = "Location",
                     labels = c("Right Knee Flexion", "Left Knee Flexion"),
                     values = c("red","black")) +
  facet_wrap(~ Group)

# EXPERIMENTATION for auto-p values (instead of method currentl used for PD and OA Plots)
my_p <- list(c("Foxtrot", "Tango"))
pub_graph <- ggplot(gg2_PD, aes(x = Dance_Type, y = value)) +
  geom_point(position = pos, aes(color = Side)) +
  geom_vline(xintercept = 1.5) +
  geom_vline(xintercept = 2.5) +
  geom_vline(xintercept = 3.5) +
  ylim(0,0.3)

pub_graph +
  stat_compare_means(comparisons = my_p, label = "p.format", method = "wilcox.test")

library(ggpubr) # Easier to make graphs. Needed for stat_compare_means
ggerrorplot(gg2_PD, "Dance_Type", "value", 
            desc_stat = "mean_sd",
            add = "jitter",
            add.params = list(color = "Side")) +
  stat_compare_means(comparisons = my_p)

```
#### Difference amongst dances

A MANOVA was run to determine whether any significant differences exist between dance types in terms of the 10 variables. This turned out to be significant (p < 0.001).

```{r pd_manova_dance, echo=FALSE}

dep_vars <- as.matrix(select(df_pd, ends_with("(deg)")))
df_pd.man <- manova(dep_vars ~ df_pd$Dance_Type)

summary(df_pd.man, test = "Pillai")
```

The dependent variables significantly different between dances include:

* SamEn_Elbow-LT-Flexion (p < 0.01)
* SamEn_Hip-RT-Abduction (p < 0.01)
* SamEn_Knee-LT-Flexion was slightly significant (p < 0.1)

The following only shows the significant results:

``` {r pd_manova_summary, echo=FALSE}
# summary.aov(df_pd.man)

print("SamEn_Elbow-LT-Flexion")
df_pd_LT_elbow.aov <- aov(df_pd$`SamEn_Elbow-LT-Flexion (deg)` ~ df_pd$Dance_Type)
summary.aov(df_pd_LT_elbow.aov)
print("SamEn_Hip-RT-Abduction")
df_pd_RT_hip.aov <- aov(df_pd$`SamEn_Hip-RT-Abduction (deg)`~ df_pd$Dance_Type)
summary.aov(df_pd_RT_hip.aov)
print("SamEn_Knee-LT-Flexion")
df_pd_LT_knee.aov <- aov(df_pd$`SamEn_Knee-LT-Flexion (deg)` ~ df_pd$Dance_Type)
summary.aov(df_pd_LT_knee.aov)
```

TukeyHSD was run to determine which dances saw the significant difference in the appropriate SamEn. 

* SamEn in LT elbow flexion was significantly different between TANGO and FOXTROT (p = 0.001)
* SamEn in RT hip abduction was significantly different between TANGO and LINE DANCE (p = 0.005), LINE DANCE and FOXTROT (p = 0.046)
* SamEn in LT knee flexion was NOT significantly different between any dances (p > 0.1 for all comparisons)

```{r pd_tukey, echo=FALSE}
print("SamEn_Elbow-LT-Flexion")
TukeyHSD(df_pd_LT_elbow.aov)

print("SamEn_Hip-RT-Abduction")
TukeyHSD(df_pd_RT_hip.aov)

print("SamEn_Knee-LT-Flexion")
TukeyHSD(df_pd_LT_knee.aov)
```